!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";class e extends Error{constructor(e,o=""){super(o),this.status=e,this.error=o,this.message=`InstagramError ${e}: ${o.response?o.response.message:o}`,this.response=o.response}}class o extends Error{}const s=new class{constructor(){this.isStopped=!1,this.isConnected=!1,this.init=async()=>{try{const e=await this.request({method:"ping"});console.log("ping",e),this.isConnected="ok"===e.status&&Boolean(e.pong)}catch(e){if(e instanceof o)return void(this.isConnected=!1);throw e}},this.start=()=>this.isStopped=!1,this.kill=()=>this.isStopped=!0}request(s){return new Promise((t,r)=>{if(this.isStopped)return r(new Error("Request was killed"));const n=Date.now(),a=(o,i)=>{const{status:c,error:l}=o;o.req_id&&n!==o.req_id||(chrome.runtime.onMessage&&chrome.runtime.onMessage.removeListener(a),console.log("request",s.method,"->",c,o),console.log(c,l),"ok"!==c?r(new e(c,l)):t(o))};setTimeout(()=>r(new o("Request timeout")),1e4),chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener(a),console.log("send_message",null,{req_id:n,...s}),chrome.runtime.sendMessage(null,{req_id:n,...s})})}};window.instagram=s;const t=async()=>{try{const{user:e}=await s.request({method:"check_login"});console.log("update view, user =",e);const o=!!e.pk;r({logged_in:o,user:e})}catch(e){r({logged_in:!1,user:null})}},r=({logged_in:e,user:o={}}={})=>{const s=(e,o)=>o?e.classList.remove("hide"):e.classList.add("hide");e?(document.querySelectorAll(".logged_in").forEach(e=>s(e,!0)),document.querySelectorAll(".not_logged_in").forEach(e=>s(e,!1))):(document.querySelectorAll(".logged_in").forEach(e=>s(e,!1)),document.querySelectorAll(".not_logged_in").forEach(e=>s(e,!0))),o&&(document.querySelector(".username-field").innerText=o.username)};window.onload=async()=>{const e=document.forms.instalogin;if(!e)return;await t(),document.querySelector("#exit").onclick=async()=>{await new Promise((e,o)=>{chrome.storage.local.set({credentials:null},o=>{e(o)}),setTimeout(()=>o("storage error"),5e3)}),await s.request({method:"exit"}),await t()},document.querySelector(".btn-get-cookies").onclick=async e=>{e.preventDefault();try{const e=await s.request({method:"login_via_cookie"});o(e)}catch(e){console.log("Login Error",e),r(e.message);const{error:{response:o}}=e;console.error(o)}},e.onsubmit=async e=>{e.preventDefault();const{username:t,password:n}=document.forms.instalogin.elements,a={username:t.value,password:n.value};try{const e=await s.request({method:"login",params:[t.value,n.value]});o(e,a)}catch(e){console.error(e);const{error:{response:i}}=e||{};if(console.error(i),i.two_factor_required){const e=i,c=prompt("Input a code for two-factor auth from SMS");if(!c)return r("No code");const l=await s.request({method:"login_2fa",params:[t.value,n.value,c,e]});"ok"===l.status?o(l,a):r(l.error.message)}else i.challenge?(r(i.message),window.open(i.challenge.url)):r(i.message)}};const o=async(e,o)=>{if(o){const{username:e,password:s}=o;await((e,o)=>new Promise((s,t)=>{chrome.storage.local.set({credentials:{username:e,password:o}},()=>{s({username:e,password:o})}),setTimeout(()=>t("storage error"),5e3)}))(e,s)}await(async()=>{const{user:e}=await s.request({method:"get_user_info",params:["instagram"]});console.log("@instagram",e.pk,e),await t()})(),window.open("https://dashboard.gramup.me/")},r=async e=>{alert(e),console.error("LoginError:",e)}}}));
//# sourceMappingURL=popup.js.map
