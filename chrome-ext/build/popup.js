!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";window.saveCredentials=(e,s)=>new Promise((o,t)=>{chrome.storage.local.set({credentials:{username:e,password:s}},()=>{o({username:e,password:s})}),setTimeout(()=>t("storage error"),5e3)}),window.getCredentials=()=>new Promise((e,s)=>{chrome.storage.local.get(["credentials"],s=>{e(s.credentials||{})}),setTimeout(()=>s("storage error"),5e3)});class e extends Error{constructor(e,s=""){super(s),this.status=e,this.error=s,this.message=`InstagramError ${e}: ${s.response?s.response.message:s}`,this.response=s.response}}class s extends Error{}const o=new class{constructor(){this.isStopped=!1,this.isConnected=!1,this.init=async()=>{try{const e=await this.request({method:"ping"});console.log("ping",e),this.isConnected="ok"===e.status&&Boolean(e.pong)}catch(e){if(e instanceof s)return void(this.isConnected=!1);throw e}},this.start=()=>this.isStopped=!1,this.kill=()=>this.isStopped=!0}request(o){return new Promise((t,r)=>{if(this.isStopped)return r(new Error("Request was killed"));const n=Date.now(),a=(s,i)=>{const{status:c,error:l}=s;s.req_id&&n!==s.req_id||(chrome.runtime.onMessage&&chrome.runtime.onMessage.removeListener(a),console.log("request",o.method,"->",c,s),console.log(c,l),"ok"!==c?r(new e(c,l)):t(s))};setTimeout(()=>r(new s("Request timeout")),1e4),chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener(a),console.log("send_message",null,{req_id:n,...o}),chrome.runtime.sendMessage(null,{req_id:n,...o})})}},t=async()=>{try{const{user:e}=await o.request({method:"check_login"});console.log("update view, user =",e);const s=!!e.pk;r({logged_in:s,user:e})}catch(e){r({logged_in:!1,user:null})}},r=({logged_in:e,user:s={}}={})=>{const o=(e,s)=>s?e.classList.remove("hide"):e.classList.add("hide");e?(document.querySelectorAll(".logged_in").forEach(e=>o(e,!0)),document.querySelectorAll(".not_logged_in").forEach(e=>o(e,!1))):(document.querySelectorAll(".logged_in").forEach(e=>o(e,!1)),document.querySelectorAll(".not_logged_in").forEach(e=>o(e,!0))),s&&(document.querySelector(".username-field").innerText=s.username)};window.onload=async()=>{const e=document.forms.instalogin;if(!e)return;await t(),document.querySelector("#exit").onclick=async()=>{await clearCredentials(),await o.request({method:"exit"}),await t()},document.querySelector(".btn-get-cookies").onclick=async e=>{e.preventDefault();try{const e=await o.request({method:"login_via_cookie"});s(e)}catch(e){console.log("Login Error",e);const{error:{response:s}}=e;console.error(s),r(res.error.message)}},e.onsubmit=async e=>{e.preventDefault();const{username:t,password:n}=instalogin.elements,a={username:t.value,password:n.value};try{const e=await o.request({method:"login",params:[t.value,n.value]});s(e,a)}catch(e){console.error(e);const{error:{response:i}}=e||{};if(console.error(i),i.two_factor_required){const e=i,c=prompt("Input a code for two-factor auth from SMS");if(!c)return r("No code");const l=await o.request({method:"login_2fa",params:[t.value,n.value,c,e]});"ok"===l.status?s(l,a):r(l.error.message)}else i.challenge?(r(i.message),window.open(i.challenge.url)):r(i.message)}};const s=async(e,s)=>{if(s){const{username:e,password:o}=s;await saveCredentials(e,o)}await(async()=>{const{user:e}=await o.request({method:"get_user_info",params:["instagram"]});console.log("@instagram",e.pk,e),await t()})(),window.open("https://dashboard.gramup.me/")},r=async e=>{alert(e),console.error("LoginError:",e)}}}));
//# sourceMappingURL=popup.js.map
